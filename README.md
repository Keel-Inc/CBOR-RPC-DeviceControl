# CBOR-RPC for Device Control

## Overview

This repository demonstrates remote procedure call protocols for embedded devices using CBOR (Concise Binary Object Representation). A Python host application controls an STM32F746 Discovery board running bare-metal firmware, sending commands and images over UART to display on the device's LCD screen.

## Build and Setup

Check out the repository
```powershell
git clone --recurse-submodules https://github.com/Keel-Inc/CBOR-RPC-DeviceControl.git
cd CBOR-RPC-DeviceControl
```

Build the Device application
```
# Build the Device application
cd .\Device
cmake --preset RelWithDebInfo
cd ..
cmake --build Device\build\RelWithDebInfo
```

Setup the Host application
```powershell
# Create a new virtual environment:
uv venv && .venv\Scripts\activate.ps1

# Install dependencies:
pip install -e 'Host/.[test,dev]'
```

Run the tests:
```powershell
python -m pytest
```

## Generate an Image

Turn any square image into a 480x272 pixel image suitable for the STM32F746G Discovery board's LCD screen
```
host make-header -i .\Images\Keel-Inc.png -o Device\Core\Inc\default_image_rgb565.h
```

## Usage

Start the Device:
```
renode --console .\Scripts\device.resc
```
Add `--disable-gui` to disable the GUI and see all output in the same terminal where the command was executed.

Send a test message:
```powershell
host test "Hello"
```

Clear the displayed image:
```powershell
host clear
```

Display the default image:
```powershell
host display
```

Send an image to display:
```powershell
host display .\Images\Keel-Inc-2.png
```

## Code Quality

Auto-format C Code (every other file is auto-generated by STM32CubeMx):
```powershell
clang-format -i Device/Core/Inc/comm.h Device/Core/Src/comm.c Device/Core/Inc/image.h Device/Core/Src/image.c
```

Format code and fix linting issues in the Host project:
```powershell
ruff check --fix . && ruff format .
```