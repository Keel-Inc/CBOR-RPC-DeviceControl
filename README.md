# CBOR-RPC for Device Control

## Build and Setup

Check out the repository
```powershell
git clone --recurse-submodules https://github.com/Keel-Inc/CBOR-RPC-DeviceControl.git
cd CBOR-RPC-DeviceControl
```

Build the Device application
```
# Build the Device application
cd .\Device
cmake --preset RelWithDebInfo
cd ..
cmake --build Device\build\RelWithDebInfo
```

Setup the Host application
```powershell
# Create a new virtual environment:
uv venv && .venv\Scripts\activate.ps1

# Install dependencies (including test):
uv sync --all-extras --directory Host
```

Run the tests:
```powershell
python -m pytest
```

## Generate an Image

Install ffmpeg
```
winget install Gyan.FFmpeg
```

Turn any square image into a 480x272 pixel image suitable for the STM32F746G Discovery board's LCD screen
```
$squareSourceImage = "Images\Keel-Inc.png"
ffmpeg -i $squareSourceImage -vf "crop='min(iw,ih*480/272)':'min(ih,iw*272/480)',scale=480:272" -f rawvideo -pix_fmt rgb565le - | `
	python Scripts\make-image-header.py -o "Device\Core\Inc\image_rgb565.h"
```

## Usage

Start the Device
```
renode --console .\Scripts\device.resc
```
Add `--disable-gui` to disable the GUI and see all output in the same terminal where the command was executed.

Start the Host
```powershell
Run-Host
```

## Code Quality

Auto-format C Code (every other file is auto-generated by STM32CubeMx):
```powershell
clang-format -i Device/Core/Inc/comm.h Device/Core/Src/comm.c
```

Format code and fix linting issues in the Host project:
```powershell
ruff check --fix . && ruff format .
```